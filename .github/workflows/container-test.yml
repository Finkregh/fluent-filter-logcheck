name: Container Test

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  container-test:
    name: Build and Test Container
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build container
        run: |
          echo "Building container from root Dockerfile..."
          docker build -t fluent-logcheck-test .

      - name: Copy test configuration files
        run: |
          echo "Copying test configuration files to container..."
          docker run --rm -v "$(pwd)/test/container-files:/host-files" \
            fluent-logcheck-test \
            sh -c "cp -a /host-files/* /etc/fluent/logcheck/"

      # Test 1: Basic SSH ignore functionality
      - name: Test 1 - Basic SSH Ignore Rules
        run: |
          echo "=== TEST 1: Basic SSH Ignore Rules ==="

          # Run container with timeout and capture exit code
          EXIT_CODE=0
          timeout --kill-after=7s 5s docker run --rm \
            -v "$(pwd)/test/container-files:/etc/fluent/logcheck" \
            fluent-logcheck-test \
            fluentd -vv -c /etc/fluent/logcheck/fluentd-test.conf \
            > test1_output.log 2>&1 || EXIT_CODE=$?

          echo "Container exit code: $EXIT_CODE"
          if [ $EXIT_CODE -eq 124 ]; then
            echo "‚úÖ Container timed out as expected (exit code 124)"
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Container completed successfully (exit code 0)"
          else
            echo "‚ö†Ô∏è  Container exited with unexpected code: $EXIT_CODE"
          fi

          echo "=== TEST 1 OUTPUT ==="
          cat test1_output.log
          echo "=== END TEST 1 OUTPUT ==="

      - name: Validate Test 1 Results
        run: |
          echo "Validating Test 1 results..."

          # Check that SSH error message is filtered out (should NOT appear in actual log output)
          # Use more specific pattern to avoid matching debug messages
          if grep -E "example-logcheck\.ignore.*fatal: recv_rexec_state: ssh_msg_recv failed" test1_output.log; then
            echo "‚ùå FAIL: SSH error message was not filtered out"
            exit 1
          else
            echo "‚úÖ PASS: SSH error message correctly filtered out"
          fi

          # Check that other fatal message passes through (should appear in actual log output)
          if grep -E "example-logcheck\.ignore.*fatal: some other message" test1_output.log; then
            echo "‚úÖ PASS: Non-SSH fatal message passed through"
          else
            echo "‚ùå FAIL: Non-SSH fatal message was incorrectly filtered"
            exit 1
          fi

      # Test 2: Comprehensive SSH ignore rules
      - name: Test 2 - Comprehensive SSH Ignore Rules
        run: |
          echo "=== TEST 2: Comprehensive SSH Ignore Rules ==="

          EXIT_CODE=0
          timeout --kill-after=7s 5s docker run --rm \
            -v "$(pwd)/test/container-files:/etc/fluent/logcheck" \
            fluent-logcheck-test \
            fluentd -vv -c /etc/fluent/logcheck/fluentd-test-ssh-ignore.conf \
            > test2_output.log 2>&1 || EXIT_CODE=$?

          echo "Container exit code: $EXIT_CODE"
          if [ $EXIT_CODE -eq 124 ]; then
            echo "‚úÖ Container timed out as expected (exit code 124)"
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Container completed successfully (exit code 0)"
          else
            echo "‚ö†Ô∏è  Container exited with unexpected code: $EXIT_CODE"
          fi

          echo "=== TEST 2 OUTPUT ==="
          cat test2_output.log
          echo "=== END TEST 2 OUTPUT ==="

      - name: Validate Test 2 Results
        run: |
          echo "Validating Test 2 results..."

          # Most SSH messages should be filtered out (check actual log output, not debug messages)
          ssh_messages_found=0
          if grep -E "ssh-logcheck\.ignore.*Accepted password for user1" test2_output.log; then
            ssh_messages_found=$((ssh_messages_found + 1))
          fi
          if grep -E "ssh-logcheck\.ignore.*Failed password for invalid user hacker" test2_output.log; then
            ssh_messages_found=$((ssh_messages_found + 1))
          fi
          if grep -E "ssh-logcheck\.ignore.*Connection closed by" test2_output.log; then
            ssh_messages_found=$((ssh_messages_found + 1))
          fi
          if grep -E "ssh-logcheck\.ignore.*fatal: recv_rexec_state: ssh_msg_recv failed" test2_output.log; then
            ssh_messages_found=$((ssh_messages_found + 1))
          fi

          if [ $ssh_messages_found -eq 0 ]; then
            echo "‚úÖ PASS: SSH messages correctly filtered out"
          else
            echo "‚ùå FAIL: $ssh_messages_found SSH messages were not filtered"
            exit 1
          fi

          # Non-SSH message should pass through (check actual log output)
          if grep -E "ssh-logcheck\.ignore.*This message should pass through" test2_output.log; then
            echo "‚úÖ PASS: Non-SSH message passed through"
          else
            echo "‚ùå FAIL: Non-SSH message was incorrectly filtered"
            exit 1
          fi

      # Test 3: Cracking rules (security alerts)
      - name: Test 3 - Cracking Rules (Security Alerts)
        run: |
          echo "=== TEST 3: Cracking Rules (Security Alerts) ==="

          EXIT_CODE=0
          timeout --kill-after=7s 5s docker run --rm \
            -v "$(pwd)/test/container-files:/etc/fluent/logcheck" \
            fluent-logcheck-test \
            fluentd -vv -c /etc/fluent/logcheck/fluentd-test-cracking.conf \
            > test3_output.log 2>&1 || EXIT_CODE=$?

          echo "Container exit code: $EXIT_CODE"
          if [ $EXIT_CODE -eq 124 ]; then
            echo "‚úÖ Container timed out as expected (exit code 124)"
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Container completed successfully (exit code 0)"
          else
            echo "‚ö†Ô∏è  Container exited with unexpected code: $EXIT_CODE"
          fi

          echo "=== TEST 3 OUTPUT ==="
          cat test3_output.log
          echo "=== END TEST 3 OUTPUT ==="

      - name: Validate Test 3 Results
        run: |
          echo "Validating Test 3 results..."

          # Security threats should generate alerts (pass through with alert metadata)
          # Check actual log output, not debug messages
          if grep -E "cracking-logcheck\.test.*Oversized packet received" test3_output.log; then
            echo "‚úÖ PASS: Security threat detected and alerted"
          else
            echo "‚ùå FAIL: Security threat was not detected"
            exit 1
          fi

          # Normal messages should pass through (check actual log output)
          if grep -E "cracking-logcheck\.test.*Regular application message" test3_output.log; then
            echo "‚úÖ PASS: Normal message passed through"
          else
            echo "‚ùå FAIL: Normal message was filtered incorrectly"
            exit 1
          fi

      # Test 4: Violations rules (policy alerts)
      - name: Test 4 - Violations Rules (Policy Alerts)
        run: |
          echo "=== TEST 4: Violations Rules (Policy Alerts) ==="

          EXIT_CODE=0
          timeout --kill-after=7s 5s docker run --rm \
            -v "$(pwd)/test/container-files:/etc/fluent/logcheck" \
            fluent-logcheck-test \
            fluentd -vv -c /etc/fluent/logcheck/fluentd-test-violations.conf \
            > test4_output.log 2>&1 || EXIT_CODE=$?

          echo "Container exit code: $EXIT_CODE"
          if [ $EXIT_CODE -eq 124 ]; then
            echo "‚úÖ Container timed out as expected (exit code 124)"
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Container completed successfully (exit code 0)"
          else
            echo "‚ö†Ô∏è  Container exited with unexpected code: $EXIT_CODE"
          fi

          echo "=== TEST 4 OUTPUT ==="
          cat test4_output.log
          echo "=== END TEST 4 OUTPUT ==="

      - name: Validate Test 4 Results
        run: |
          echo "Validating Test 4 results..."

          # Policy violations should generate alerts (check actual log output)
          violations_found=0
          if grep -E "violations-logcheck\.test.*session opened for user root" test4_output.log; then
            violations_found=$((violations_found + 1))
          fi
          if grep -E "violations-logcheck\.test.*authentication failure" test4_output.log; then
            violations_found=$((violations_found + 1))
          fi

          if [ $violations_found -gt 0 ]; then
            echo "‚úÖ PASS: Policy violations detected and alerted ($violations_found found)"
          else
            echo "‚ùå FAIL: Policy violations were not detected"
            exit 1
          fi

          # Normal application message should pass through (check actual log output)
          if grep -E "violations-logcheck\.test.*Normal application activity" test4_output.log; then
            echo "‚úÖ PASS: Normal application message passed through"
          else
            echo "‚ùå FAIL: Normal application message was filtered incorrectly"
            exit 1
          fi

      # Test 5: Multi-rule priority system
      - name: Test 5 - Multi-Rule Priority System
        run: |
          echo "=== TEST 5: Multi-Rule Priority System ==="

          EXIT_CODE=0
          timeout --kill-after=12s 10s docker run --rm \
            -v "$(pwd)/test/container-files:/etc/fluent/logcheck" \
            fluent-logcheck-test \
            fluentd -vv -c /etc/fluent/logcheck/fluentd-test-multi-rules.conf \
            > test5_output.log 2>&1 || EXIT_CODE=$?

          echo "Container exit code: $EXIT_CODE"
          if [ $EXIT_CODE -eq 124 ]; then
            echo "‚úÖ Container timed out as expected (exit code 124)"
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Container completed successfully (exit code 0)"
          else
            echo "‚ö†Ô∏è  Container exited with unexpected code: $EXIT_CODE"
          fi

          echo "=== TEST 5 OUTPUT ==="
          cat test5_output.log
          echo "=== END TEST 5 OUTPUT ==="

      - name: Validate Test 5 Results
        run: |
          echo "Validating Test 5 results..."

          # Check rule loading
          if grep -q "rules loaded" test5_output.log; then
            echo "‚úÖ PASS: Rules loaded successfully"
          else
            echo "‚ö†Ô∏è  WARNING: Rule loading message not found"
          fi

          # Security threats (cracking) should be alerted with highest priority (check actual log output)
          if grep -E "multi-logcheck\.test.*Oversized packet received" test5_output.log; then
            echo "‚úÖ PASS: Cracking rule detected (highest priority)"
          else
            echo "‚ùå FAIL: Cracking rule not detected"
            exit 1
          fi

          # Policy violations should be alerted (check actual log output)
          if grep -E "multi-logcheck\.test.*session opened for user root" test5_output.log; then
            echo "‚úÖ PASS: Violations rule detected"
          else
            echo "‚ùå FAIL: Violations rule not detected"
            exit 1
          fi

          # SSH messages should be ignored (lowest priority) - check they don't appear in actual log output
          ssh_ignored=0
          if ! grep -E "multi-logcheck\.test.*Accepted password for user1" test5_output.log; then
            ssh_ignored=$((ssh_ignored + 1))
          fi
          if ! grep -E "multi-logcheck\.test.*Failed password for invalid user hacker" test5_output.log; then
            ssh_ignored=$((ssh_ignored + 1))
          fi
          if ! grep -E "multi-logcheck\.test.*fatal: recv_rexec_state: ssh_msg_recv failed" test5_output.log; then
            ssh_ignored=$((ssh_ignored + 1))
          fi

          if [ $ssh_ignored -ge 2 ]; then
            echo "‚úÖ PASS: SSH messages correctly ignored (rule priority working)"
          else
            echo "‚ùå FAIL: SSH messages not properly ignored"
            exit 1
          fi

          # Normal application message should pass through (check actual log output)
          if grep -E "multi-logcheck\.test.*Normal application message that should pass through" test5_output.log; then
            echo "‚úÖ PASS: Normal message passed through"
          else
            echo "‚ùå FAIL: Normal message was filtered incorrectly"
            exit 1
          fi

          # Check for alert metadata if mark_matches is enabled
          if grep -q "logcheck_" test5_output.log; then
            echo "‚úÖ PASS: Alert metadata found"
          else
            echo "‚ö†Ô∏è  INFO: Alert metadata not found (may be expected)"
          fi

      - name: Final Test Summary
        run: |
          echo "üéâ All container tests completed successfully!"
          echo ""
          echo "Test Summary:"
          echo "‚úÖ Test 1: Basic SSH ignore functionality"
          echo "‚úÖ Test 2: Comprehensive SSH ignore rules"
          echo "‚úÖ Test 3: Cracking rules (security alerts)"
          echo "‚úÖ Test 4: Violations rules (policy alerts)"
          echo "‚úÖ Test 5: Multi-rule priority system"
          echo ""
          echo "The fluent-plugin-logcheck container is working correctly!"

      - name: Upload all test logs as artifacts
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: container-test-logs
          path: |
            test1_output.log
            test2_output.log
            test3_output.log
            test4_output.log
            test5_output.log
          retention-days: 7
